<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>67: NEON RUSH</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; }
        /* Espaço seguro para o Banner no topo */
        canvas { margin-top: 50px; } 
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <!-- Script necessário para o Cordova (será injetado na compilação, não se preocupe se der 404 agora) -->
    <script src="cordova.js"></script> 
</head>
<body>

<script>
// ==========================================
// GERENCIADOR DE ANÚNCIOS (ADMOB)
// ==========================================
const AdManager = {
    interstitial: null,
    rewarded: null,
    bannerActive: false,
    deaths: 0,
    isApp: false, // Detecta se está no app ou navegador

    init: function() {
        document.addEventListener('deviceready', () => {
            this.isApp = true;
            this.setupAdMob();
        }, false);
    },

    setupAdMob: function() {
        if (!window.admob) return;

        // IDs DE TESTE DO GOOGLE (Troque pelos seus REAIS antes de publicar)
        const ids = {
            banner: 'ca-app-pub-3940256099942544/6300978111', 
            interstitial: 'ca-app-pub-3940256099942544/1033173712',
            reward: 'ca-app-pub-3940256099942544/5224354917'
        };

        // 1. Configurar Banner (Topo, Fixo)
        admob.banner.config({
            id: ids.banner,
            isTesting: true,
            autoShow: true,
            overlap: false, // Empurra o conteúdo webview para baixo
            position: admob.banner.position.TOP_CENTER
        });
        admob.banner.prepare();

        // 2. Preparar Intersticial
        admob.interstitial.config({ id: ids.interstitial, isTesting: true });
        admob.interstitial.prepare();

        // 3. Preparar Reward
        admob.rewardvideo.config({ id: ids.reward, isTesting: true });
        admob.rewardvideo.prepare();
    },

    checkInterstitial: function() {
        this.deaths++;
        // Exibir a cada 3 mortes
        if (this.deaths % 3 === 0 && this.isApp) {
            admob.interstitial.show().then(() => {
                admob.interstitial.prepare(); // Já carrega o próximo
            }).catch(e => console.log(e));
        }
    },

    showReward: function(onSuccess) {
        if (!this.isApp) {
            alert("No computador/navegador o anúncio é simulado.");
            onSuccess(); // Simula sucesso no PC
            return;
        }

        admob.rewardvideo.show().then(() => {
            onSuccess();
            admob.rewardvideo.prepare();
        }).catch(e => {
            console.log("Falha ao exibir reward", e);
        });
    }
};

AdManager.init();

// ==========================================
// DADOS DO JOGO
// ==========================================

const THEMES = [
    { range: 0,   bg: 0x000000, btn6: 0x9D00FF, btn7: 0x00FFFF },
    { range: 100, bg: 0x002200, btn6: 0x00FF00, btn7: 0xCCFF00 },
    { range: 200, bg: 0x330000, btn6: 0xFF4500, btn7: 0x111111 },
    { range: 300, bg: 0xFF0066, btn6: 0xFFFF00, btn7: 0x0055FF },
    { range: 400, bg: 0x000000, btn6: 0x00FF33, btn7: 0xFFFFFF }
];

const HYPE_TEXTS = ["AURA +10", "RIZZ", "INSANE", "MOGGED", "GOATED", "W CLICK"];

const RANKS = [
    { min: 0,    title: "NOOB (L AURA)",       color: "#ff0000" },
    { min: 100,  title: "SIGMA CHAD",          color: "#00ffff" },
    { min: 500,  title: "RIZZLER ELITE",       color: "#ff00ff" },
    { min: 1000, title: "AURA GOD",            color: "#ffd700" },
    { min: 5000, title: "SKIBIDI ASCENDED",    color: "#ffffff" }
];

class GameScene extends Phaser.Scene {
    constructor() { super('GameScene'); }

    create(data) {
        // Se vier de um revive, mantém o score, senão zera
        this.score = (data && data.score) ? data.score : 0;
        this.highScore = parseInt(localStorage.getItem('67_highscore') || 0);
        this.gameActive = false;
        this.nextNumber = 6;
        this.maxTime = 100;
        this.currentTime = 100;
        this.depletionRate = 0.2 + (this.score * 0.001); // Dificuldade ajustada
        this.combo = 0;
        this.currentThemeIndex = Math.floor(this.score / 100);
        
        this.synth = new (window.AudioContext || window.webkitAudioContext)();

        // Background
        let initialTheme = THEMES[Math.min(this.currentThemeIndex, THEMES.length-1)];
        this.bgRect = this.add.rectangle(0, 0, this.scale.width, this.scale.height, initialTheme.bg).setOrigin(0);

        this.grid = this.add.grid(this.scale.width/2, this.scale.height/2, this.scale.width * 2, this.scale.height * 2, 60, 60, 0x000000, 0, 0xffffff, 0.1);

        // UI
        this.timeBarBg = this.add.rectangle(this.scale.width/2, 60, this.scale.width - 60, 20, 0x000000).setStrokeStyle(2, 0xffffff).setDepth(10);
        this.timeBar = this.add.rectangle(this.scale.width/2, 60, this.scale.width - 64, 16, 0x00ff00).setDepth(10);
        
        this.scoreText = this.add.text(this.scale.width / 2, 140, this.score.toString(), {
            fontFamily: '"Fredoka One"', fontSize: '90px', color: '#fff'
        }).setOrigin(0.5).setDepth(10);

        this.highScoreText = this.add.text(this.scale.width / 2, 200, `BEST: ${this.highScore}`, {
            fontFamily: '"Fredoka One"', fontSize: '24px', color: '#ffd700'
        }).setOrigin(0.5).setDepth(10);

        // Botões
        let btnY = this.scale.height - 180;
        this.btn6 = this.createNeonButton(this.scale.width * 0.25, btnY, '6', initialTheme.btn6);
        this.btn6.on('pointerdown', () => this.handleInput(6, this.btn6));

        this.btn7 = this.createNeonButton(this.scale.width * 0.75, btnY, '7', initialTheme.btn7);
        this.btn7.on('pointerdown', () => this.handleInput(7, this.btn7));

        // Partículas
        this.createParticleTexture();
        this.particles = this.add.particles(0, 0, 'flare', {
            speed: { min: 200, max: 400 },
            scale: { start: 0.6, end: 0 },
            blendMode: 'ADD',
            lifespan: 300,
            on: false
        });

        // Se for revive, começa direto
        if (data && data.isRevive) {
            this.startGame();
        } else {
            this.tutorialText = this.add.text(this.btn6.x, this.btn6.y - 100, "START HERE", {
                fontFamily: '"Fredoka One"', fontSize: '20px', color: '#00f2ff'
            }).setOrigin(0.5);
            this.tweens.add({ targets: [this.tutorialText, this.btn6], scaleX: 1.1, scaleY: 1.1, alpha: 0.8, yoyo: true, repeat: -1, duration: 600 });
        }
    }

    createNeonButton(x, y, text, colorHex) {
        let container = this.add.container(x, y);
        let glow = this.add.circle(0, 0, 85, colorHex).setAlpha(0.3).setBlendMode('ADD');
        let circle = this.add.circle(0, 0, 75, 0x111111).setStrokeStyle(6, colorHex);
        let txt = this.add.text(0, 0, text, { fontFamily: '"Fredoka One"', fontSize: '80px', color: '#ffffff' }).setOrigin(0.5);
        container.add([glow, circle, txt]);
        container.glowObj = glow;
        container.circleObj = circle;
        container.setInteractive(new Phaser.Geom.Circle(0, 0, 100), Phaser.Geom.Circle.Contains);
        return container;
    }

    createParticleTexture() {
        if(this.textures.exists('flare')) return;
        let gfx = this.make.graphics({x:0, y:0, add: false});
        gfx.fillStyle(0xffffff, 1);
        gfx.fillCircle(16,16,16);
        gfx.generateTexture('flare', 32, 32);
    }

    startGame() {
        this.gameActive = true;
        if(this.tutorialText) this.tutorialText.destroy();
        this.tweens.killTweensOf(this.btn6); 
        this.btn6.setScale(1);
    }

    vibrate(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }

    applyTheme(index) {
        if(index >= THEMES.length) return;
        let t = THEMES[index];
        this.bgRect.setFillStyle(t.bg);
        this.btn6.glowObj.setFillStyle(t.btn6);
        this.btn6.circleObj.setStrokeStyle(6, t.btn6);
        this.btn7.glowObj.setFillStyle(t.btn7);
        this.btn7.circleObj.setStrokeStyle(6, t.btn7);
        this.cameras.main.flash(400, 0xffffff);
    }

    handleInput(number, btnObject) {
        if (this.synth.state === 'suspended') this.synth.resume();

        if (!this.gameActive) {
            if (number === 6) this.startGame();
            else return;
        }

        this.tweens.add({ targets: btnObject, scaleX: 1.2, scaleY: 0.8, duration: 50, yoyo: true });

        if (number === this.nextNumber) {
            this.score++;
            this.combo++;
            this.scoreText.setText(this.score);
            this.nextNumber = (this.nextNumber === 6) ? 7 : 6;
            this.vibrate(20);
            this.playTone(number === 6 ? 440 : 880, 'sine');
            this.currentTime = Math.min(this.currentTime + 15, this.maxTime);
            
            if (this.score < 70 && this.depletionRate < 1.3) this.depletionRate *= 1.02;

            this.particles.emitParticleAt(btnObject.x, btnObject.y, 10);

            if (this.score > 50) {
                let target = (number === 6) ? this.btn7 : this.btn6;
                this.tweens.add({ targets: target, y: Phaser.Math.Between(this.scale.height * 0.4, this.scale.height - 150), duration: 200, ease: 'Back.out' });
            }

            let themeIndex = Math.floor(this.score / 100);
            if (themeIndex < THEMES.length && themeIndex !== this.currentThemeIndex) {
                this.currentThemeIndex = themeIndex;
                this.applyTheme(themeIndex);
            }

            if (this.score % 10 === 0) {
                let txt = HYPE_TEXTS[Math.floor(Math.random() * HYPE_TEXTS.length)];
                let floating = this.add.text(this.scale.width/2, this.scale.height/2, txt, {
                    fontFamily: '"Fredoka One"', fontSize: '50px', color: '#fff', stroke: '#ff00ff', strokeThickness: 5
                }).setOrigin(0.5);
                this.tweens.add({ targets: floating, y: this.scale.height/2 - 100, alpha: 0, duration: 800, onComplete: () => floating.destroy() });
                this.playHypeSound();
            }

        } else {
            this.playTone(150, 'sawtooth');
            this.cameras.main.shake(200, 0.02);
            this.currentTime -= 30; 
            this.combo = 0;
        }
    }

    update(time, delta) {
        this.grid.tilePositionY -= 0.5;
        if (!this.gameActive) return;

        this.currentTime -= this.depletionRate * (delta / 16);
        let pct = this.currentTime / this.maxTime;
        
        this.timeBar.width = (this.scale.width - 64) * Math.max(0, pct);
        
        if (pct < 0.3) this.timeBar.fillColor = 0xff0000;
        else if (pct < 0.6) this.timeBar.fillColor = 0xffff00;
        else this.timeBar.fillColor = 0x00ff00;

        if (this.currentTime <= 0) {
            this.gameActive = false;
            this.vibrate([500, 100, 500]);
            this.scene.start('GameOverScene', { score: this.score });
        }
    }

    playTone(freq, type) {
        try {
            const osc = this.synth.createOscillator();
            const gain = this.synth.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.synth.currentTime);
            gain.gain.setValueAtTime(0.1, this.synth.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.synth.currentTime + 0.1);
            osc.connect(gain); gain.connect(this.synth.destination);
            osc.start(); osc.stop(this.synth.currentTime + 0.1);
        } catch(e) {}
    }

    playHypeSound() {
        try {
            const osc = this.synth.createOscillator();
            const gain = this.synth.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, this.synth.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, this.synth.currentTime + 0.3);
            gain.gain.setValueAtTime(0.2, this.synth.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.synth.currentTime + 0.3);
            osc.connect(gain); gain.connect(this.synth.destination);
            osc.start(); osc.stop(this.synth.currentTime + 0.3);
        } catch(e) {}
    }
}

class GameOverScene extends Phaser.Scene {
    constructor() { super('GameOverScene'); }
    init(data) { 
        this.score = data.score;
        let saved = parseInt(localStorage.getItem('67_highscore') || 0);
        if (this.score > saved) localStorage.setItem('67_highscore', this.score);
        
        // CHECK INTERSTITIAL (A cada 3 mortes)
        AdManager.checkInterstitial();
    }

    create() {
        this.add.rectangle(0, 0, this.scale.width, this.scale.height, 0x000000, 0.95).setOrigin(0);
        let cx = this.scale.width / 2;
        let cy = this.scale.height / 2;

        let currentRank = RANKS[0];
        for(let r of RANKS) if(this.score >= r.min) currentRank = r;

        this.add.text(cx, cy - 180, currentRank.title, { 
            fontFamily: '"Fredoka One"', fontSize: '30px', color: currentRank.color, align: 'center', stroke: '#fff', strokeThickness: 2 
        }).setOrigin(0.5);
        
        this.add.text(cx, cy - 100, `${this.score} PTS`, { fontFamily: '"Fredoka One"', fontSize: '80px', color: '#fff' }).setOrigin(0.5);

        // BOTÃO RETRY (NORMAL)
        let btnRetry = this.createButton(cx, cy + 40, "RETRY", 0xffffff, () => {
            this.scene.start('GameScene', { score: 0, isRevive: false });
        });

        // BOTÃO REVIVE (ADS) - Com segurança de delay
        this.reviveContainer = this.createButton(cx, cy + 140, "REVIVE (AD)", 0x00ff00, () => {
            if(this.reviveBtnActive) {
                AdManager.showReward(() => {
                    this.scene.start('GameScene', { score: this.score, isRevive: true });
                });
            }
        });
        
        // Lógica de Segurança anti-clique acidental
        this.reviveBtnActive = false;
        this.reviveContainer.alpha = 0.5;
        this.time.delayedCall(1000, () => { // 1 segundo de delay para habilitar o clique
            this.reviveBtnActive = true;
            this.tweens.add({ targets: this.reviveContainer, alpha: 1, scaleX: 1.05, scaleY: 1.05, yoyo: true, repeat: -1, duration: 600 });
        });
    }

    createButton(x, y, text, color, callback) {
        let btn = this.add.container(x, y);
        let bg = this.add.rectangle(0, 0, 250, 70, color).setStrokeStyle(4, 0xffffff);
        let txt = this.add.text(0, 0, text, { fontFamily: '"Fredoka One"', fontSize: '30px', color: '#000' }).setOrigin(0.5);
        btn.add([bg, txt]);
        btn.setInteractive(new Phaser.Geom.Rectangle(-125, -35, 250, 70), Phaser.Geom.Rectangle.Contains);
        btn.on('pointerdown', callback);
        return btn;
    }
}

const config = {
    type: Phaser.AUTO,
    scale: {
        mode: Phaser.Scale.RESIZE,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        width: window.innerWidth,
        height: window.innerHeight
    },
    backgroundColor: '#000000', // Banner area
    scene: [GameScene, GameOverScene]
};

const game = new Phaser.Game(config);
</script>
</body>
</html>

